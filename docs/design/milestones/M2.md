---
doc_version: 2025-10-21.r2
title: M2 — OIDC Integration via Authelia
---

# M2 — OIDC (OAuth 2.1 + PKCE) via Authelia

## Goals / Scope
- Integrate Authelia as OIDC Provider (OP).
- Users authenticate via Authelia (Auth Code + PKCE).
- FastAPI resource server validates JWTs: issuer (iss), audience (aud), exp/nbf, signature; select key by `kid`.
- Graceful key rotation via JWKS endpoint with caching.

## Architecture / Design
- Browser → Authelia (Auth Code + PKCE) → client obtains tokens.
- Client calls MCP Devhatchery API with `Authorization: Bearer <access_token>`.
- Middleware `OidcAuthMiddleware` loads JWKS from `OIDC_JWKS_URL` or via the issuer's `/.well-known/openid-configuration`.
- Cache keys for ~5 minutes; match `kid`; verify signature and standard claims (`iss`, `aud`, `exp`, `nbf`).
- Map `sub`/`preferred_username` to OwnerContext `owner`.

## Config
- `AUTH_MODE=oidc` enables OIDC path.
- `REQUIRE_JWT=true` to enforce OIDC for all routes.
- Required: `OIDC_ISSUER`, `OIDC_AUDIENCE`. Optional: override JWKS URL.

## Validation / Testing
- Unit: generate JWTs with rotating `kid`; verify signature & claim validation; allow small clock skew.
- Negative: `aud`/`iss` mismatch; expired/nbf-in-future; unknown `kid`.
- Integration: serve mock JWKS; rotate keys and ensure cache refresh behavior.

## Risks
- Clock skew; stale JWKS cache; token replay. Mitigate with short cache TTL and `exp` checks.

## Migration
- Keep bearer auth behind `AUTH_MODE=bearer` for local dev.
- Allow `AUTH_MODE=oidc` in M2; add `.env.example` knobs.

## Open Questions
- Multi-tenant audiences? Multiple client_ids?
