---
doc_version: 2025-10-21.r1
title: M2 — OIDC Integration via Authelia
---

# M2 — OIDC (OAuth 2.1 + PKCE) via Authelia

## Goals
- Users authenticate via Authelia (OP).
- API validates JWTs (iss/aud/kid/signature/exp/nbf).
- Graceful key rotation using JWKS cache.

## Design
- Middleware `OidcAuthMiddleware` loads JWKS from `OIDC_JWKS_URL` or `/.well-known/openid-configuration` of `OIDC_ISSUER`.
- Cache keys for 5 minutes; match `kid`; verify signature.
- Map `sub` and `preferred_username` to OwnerContext owner.

## Config
- `REQUIRE_JWT=true` to enforce OIDC.
- `OIDC_ISSUER`, `OIDC_AUDIENCE` required.

## Testing
- Unit: generate JWTs with rotating kids; verify failure on aud/iss mismatch.
- Integration: serve mock JWKS; rotate keys; ensure cache refresh.

## Migration
- Keep bearer auth behind `AUTH_MODE=bearer` for local dev; allow `AUTH_MODE=oidc` in M2.
